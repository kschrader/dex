---
interface Props {
  title: string;
  description?: string;
}

const { title, description = 'Task tracking for Agents' } = Astro.props;
const currentPath = Astro.url.pathname;
const base = import.meta.env.BASE_URL.replace(/\/$/, '');
---

<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="description" content={description} />
    <!-- Open Graph -->
    <meta property="og:type" content="website" />
    <meta property="og:title" content={`${title} | dex`} />
    <meta property="og:description" content={description} />
    <meta property="og:image" content="https://dex.rip/og-image.svg" />
    <meta property="og:url" content={Astro.url.href} />
    <meta property="og:site_name" content="dex" />
    <!-- Twitter Card -->
    <meta name="twitter:card" content="summary_large_image" />
    <meta name="twitter:title" content={`${title} | dex`} />
    <meta name="twitter:description" content={description} />
    <meta name="twitter:image" content="https://dex.rip/og-image.svg" />
    <title>{title} | dex</title>
    <link rel="icon" type="image/svg+xml" href={`${base}/favicon.svg`} />
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet" />
  </head>
  <body>
    <nav class="nav">
      <div class="nav-inner container">
        <a href={`${base}/`} class="nav-logo">dex</a>
        <button class="nav-toggle" aria-label="Toggle menu" aria-expanded="false">
          <span class="hamburger"></span>
        </button>
        <div class="nav-links">
          <a href={`${base}/install`} class:list={[{ active: currentPath.endsWith('/install') || currentPath.endsWith('/install/') }]}>Install</a>
          <a href={`${base}/skills`} class:list={[{ active: currentPath.endsWith('/skills') || currentPath.endsWith('/skills/') }]}>Skills</a>
          <a href={`${base}/guide`} class:list={[{ active: currentPath.endsWith('/guide') || currentPath.endsWith('/guide/') }]}>Guide</a>
          <a href={`${base}/config`} class:list={[{ active: currentPath.endsWith('/config') || currentPath.endsWith('/config/') }]}>Config</a>
          <a href={`${base}/cli`} class:list={[{ active: currentPath.endsWith('/cli') || currentPath.endsWith('/cli/') }]}>CLI</a>
          <a href="https://github.com/dcramer/dex" class="nav-github" aria-label="GitHub">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
              <path d="M12 0c-6.626 0-12 5.373-12 12 0 5.302 3.438 9.8 8.207 11.387.599.111.793-.261.793-.577v-2.234c-3.338.726-4.033-1.416-4.033-1.416-.546-1.387-1.333-1.756-1.333-1.756-1.089-.745.083-.729.083-.729 1.205.084 1.839 1.237 1.839 1.237 1.07 1.834 2.807 1.304 3.492.997.107-.775.418-1.305.762-1.604-2.665-.305-5.467-1.334-5.467-5.931 0-1.311.469-2.381 1.236-3.221-.124-.303-.535-1.524.117-3.176 0 0 1.008-.322 3.301 1.23.957-.266 1.983-.399 3.003-.404 1.02.005 2.047.138 3.006.404 2.291-1.552 3.297-1.23 3.297-1.23.653 1.653.242 2.874.118 3.176.77.84 1.235 1.911 1.235 3.221 0 4.609-2.807 5.624-5.479 5.921.43.372.823 1.102.823 2.222v3.293c0 .319.192.694.801.576 4.765-1.589 8.199-6.086 8.199-11.386 0-6.627-5.373-12-12-12z"/>
            </svg>
          </a>
        </div>
      </div>
    </nav>
    <script>
      const toggle = document.querySelector('.nav-toggle');
      const nav = document.querySelector('.nav');
      toggle?.addEventListener('click', () => {
        const expanded = toggle.getAttribute('aria-expanded') === 'true';
        toggle.setAttribute('aria-expanded', String(!expanded));
        nav?.classList.toggle('nav-open');
      });

      // Add anchor links to headings
      function slugify(text: string): string {
        return text
          .toLowerCase()
          .replace(/[^a-z0-9]+/g, '-')
          .replace(/(^-|-$)/g, '');
      }

      const headings = document.querySelectorAll('main h2, main h3, main h4');
      const usedIds = new Set<string>();

      headings.forEach((heading) => {
        const text = heading.textContent || '';
        let id = slugify(text);

        // Handle duplicates
        let counter = 1;
        let uniqueId = id;
        while (usedIds.has(uniqueId)) {
          uniqueId = `${id}-${counter++}`;
        }
        usedIds.add(uniqueId);

        heading.id = uniqueId;

        const anchor = document.createElement('a');
        anchor.href = `#${uniqueId}`;
        anchor.className = 'heading-anchor';
        anchor.textContent = '#';
        anchor.setAttribute('aria-label', `Link to ${text}`);
        heading.prepend(anchor);
      });

      // Scroll to anchor on load if hash present
      if (window.location.hash) {
        const target = document.querySelector(window.location.hash);
        if (target) {
          setTimeout(() => target.scrollIntoView(), 0);
        }
      }

      // Package manager preference (shared across all pages)
      const PM_STORAGE_KEY = 'dex-docs-pm';

      function setPackageManager(pm: string) {
        document.querySelectorAll('.pm-tabs').forEach((container) => {
          const buttons = container.querySelectorAll('.tab-btn');
          const contents = container.querySelectorAll('.tab-content');

          buttons.forEach((btn) => {
            btn.classList.toggle('active', btn.getAttribute('data-pm') === pm);
          });

          contents.forEach((content) => {
            content.classList.toggle('hidden', content.getAttribute('data-pm') !== pm);
          });
        });
      }

      function initPackageManagerTabs() {
        const savedPm = localStorage.getItem(PM_STORAGE_KEY);
        if (savedPm) {
          setPackageManager(savedPm);
        }

        document.querySelectorAll('.pm-tabs').forEach((container) => {
          container.querySelectorAll('.tab-btn').forEach((btn) => {
            btn.addEventListener('click', () => {
              const pm = btn.getAttribute('data-pm');
              if (!pm) return;
              localStorage.setItem(PM_STORAGE_KEY, pm);
              setPackageManager(pm);
            });
          });

          const copyButton = container.querySelector('.copy-button');
          if (copyButton) {
            copyButton.addEventListener('click', async () => {
              const activeContent = container.querySelector('.tab-content:not(.hidden)');
              if (!activeContent) return;

              const textToCopy = (activeContent.textContent || '').replace(/^\s*[$>]\s*/, '').trim();

              try {
                await navigator.clipboard.writeText(textToCopy);
                copyButton.classList.add('copied');
                setTimeout(() => copyButton.classList.remove('copied'), 2000);
              } catch (err) {
                console.error('Failed to copy:', err);
              }
            });
          }
        });
      }

      initPackageManagerTabs();
      document.addEventListener('astro:page-load', initPackageManagerTabs);
    </script>
    <main class="container">
      <slot />
    </main>
    <footer class="footer">
      <div class="container">
        <p>MIT License &middot; <a href="https://github.com/dcramer/dex">GitHub</a></p>
        <p class="easter-egg">Not to be confused with <a href="https://x.com/dexhorthy">Dex</a></p>
      </div>
    </footer>
  </body>
</html>

<style is:global>
  @import '../styles/global.css';

  .nav {
    padding: 1rem 0;
    position: sticky;
    top: 0;
    background: rgba(0, 0, 0, 0.9);
    backdrop-filter: saturate(180%) blur(20px);
    -webkit-backdrop-filter: saturate(180%) blur(20px);
    z-index: 100;
  }

  .nav-inner {
    display: flex;
    justify-content: space-between;
    align-items: center;
  }

  .nav-logo,
  .nav-logo:link,
  .nav-logo:visited,
  .nav-logo:active {
    font-family: var(--font-mono);
    font-size: 1.5rem;
    font-weight: 700;
    color: #fff !important;
    letter-spacing: -0.02em;
  }

  .nav-logo:hover {
    color: #fff !important;
    opacity: 0.8;
  }

  .nav-links {
    display: flex;
    gap: 2rem;
    align-items: center;
  }

  .nav-links a {
    color: #fff;
    font-size: 0.875rem;
    font-weight: 500;
    transition: opacity 0.15s ease;
    padding-bottom: 4px;
    border-bottom: 4px solid transparent;
    margin-bottom: -4px;
  }

  .nav-links a:hover {
    color: #fff;
    opacity: 0.7;
  }

  .nav-links a.active {
    color: #fff;
    border-bottom-color: #fff;
    opacity: 1;
  }

  .nav-github {
    margin-left: 1rem;
    display: flex;
    align-items: center;
    padding-bottom: 0;
    border-bottom: none;
    margin-bottom: 0;
  }

  .nav-github:hover {
    opacity: 0.7;
  }

  .nav-github svg {
    display: block;
  }

  .footer {
    border-top: 1px solid var(--border);
    padding: 2.5rem 0;
    margin-top: 4rem;
    text-align: center;
  }

  .footer p {
    color: var(--text-tertiary);
    font-size: 0.8125rem;
    margin: 0;
  }

  .footer a {
    color: var(--text-secondary);
  }

  .footer a:hover {
    color: var(--text);
  }

  .footer .easter-egg {
    font-size: 0.6875rem;
    margin-top: 0.75rem;
    opacity: 0.5;
  }

  /* Hamburger button */
  .nav-toggle {
    display: none;
    background: none;
    border: none;
    cursor: pointer;
    padding: 0.5rem;
    margin-right: -0.5rem;
  }

  .hamburger {
    display: block;
    width: 20px;
    height: 2px;
    background: #fff;
    position: relative;
    transition: background 0.2s ease;
  }

  .hamburger::before,
  .hamburger::after {
    content: '';
    position: absolute;
    left: 0;
    width: 20px;
    height: 2px;
    background: #fff;
    transition: transform 0.2s ease;
  }

  .hamburger::before {
    top: -6px;
  }

  .hamburger::after {
    top: 6px;
  }

  /* Animate to X when open */
  .nav-open .hamburger {
    background: transparent;
  }

  .nav-open .hamburger::before {
    transform: translateY(6px) rotate(45deg);
  }

  .nav-open .hamburger::after {
    transform: translateY(-6px) rotate(-45deg);
  }

  @media (max-width: 768px) {
    .nav-toggle {
      display: block;
    }

    .nav-links {
      display: none;
      position: absolute;
      top: 100%;
      left: 0;
      right: 0;
      background: rgba(0, 0, 0, 0.95);
      backdrop-filter: saturate(180%) blur(20px);
      -webkit-backdrop-filter: saturate(180%) blur(20px);
      flex-direction: column;
      padding: 1rem 1.5rem 1.5rem;
      gap: 0;
      border-top: 1px solid rgba(255, 255, 255, 0.1);
    }

    .nav-open .nav-links {
      display: flex;
    }

    .nav-links a {
      padding: 0.75rem 0;
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
      margin-bottom: 0;
    }

    .nav-links a:last-child {
      border-bottom: none;
    }

    .nav-github {
      margin-left: 0;
      padding-left: 0;
      border-left: none;
      padding-top: 1rem;
      margin-top: 0.5rem;
    }
  }
</style>
