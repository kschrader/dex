---
import Base from '../layouts/Base.astro';
import Terminal from '../components/Terminal.astro';
import { Code } from 'astro:components';
---

<Base title="Config" description="Configure dex storage and sync options">
  <h1>Config</h1>

  <p>Dex can be configured via a <code>dex.toml</code> file in your project root or home directory.</p>

  <h2>Storage</h2>

  <p>Dex supports two storage modes:</p>

  <table>
    <thead>
      <tr>
        <th>Mode</th>
        <th>Location</th>
        <th>Best For</th>
      </tr>
    </thead>
    <tbody>
      <tr>
        <td><strong>in-repo</strong> (default)</td>
        <td><code>.dex/</code> at git root</td>
        <td>Team projects, version-controlled tasks</td>
      </tr>
      <tr>
        <td><strong>centralized</strong></td>
        <td><code>~/.dex/projects/&lt;key&gt;/</code></td>
        <td>Personal tasks, cross-project views</td>
      </tr>
    </tbody>
  </table>

  <h3>In-Repo</h3>

  <p>Tasks stored in <code>.dex/tasks.jsonl</code> in your git repository (one task per line). No configuration needed. Old formats are auto-migrated.</p>

  <p><strong>When to commit .dex/:</strong></p>
  <ul>
    <li>Shared projects where task history matters</li>
    <li>Long-running work that spans team members</li>
  </ul>

  <p><strong>When to gitignore .dex/:</strong></p>
  <ul>
    <li>Personal tasks only</li>
    <li>High task churn</li>
  </ul>

  <h3>Centralized</h3>

  <p>Store tasks in a project-specific folder under <code>~/.dex/projects/</code>:</p>

  <Terminal title="dex.toml">
    <Code
      code={`[storage]
engine = "file"

[storage.file]
mode = "centralized"`}
      lang="toml"
      theme="vitesse-black"
    />
  </Terminal>

  <h3>Path Overrides</h3>

  <p>Override the storage path via environment variable or CLI flag:</p>

  <Terminal title="Terminal">
    <Code
      code={`# Environment variable
export DEX_STORAGE_PATH=/custom/path/.dex

# CLI flag
dex list --storage-path /custom/path/.dex`}
      lang="bash"
      theme="vitesse-black"
    />
  </Terminal>

  <h2 id="github-sync">GitHub Sync</h2>

  <p>Sync tasks to GitHub Issues. Owner/repo are auto-detected from your git remote.</p>

  <Terminal title=".dex/config.toml">
    <Code
      code={`[sync.github]
enabled = true`}
      lang="toml"
      theme="vitesse-black"
    />
  </Terminal>

  <p><strong>Authentication:</strong> Uses <code>gh</code> CLI auth by default. Alternatively, set <code>GITHUB_TOKEN</code> environment variable.</p>

  <p><strong>Behavior:</strong></p>
  <ul>
    <li>Top-level tasks → GitHub Issues</li>
    <li>Subtasks → Embedded in parent issue body as checklist</li>
    <li>Completed tasks → Issue closed (only after pushed to remote)</li>
    <li>Sync is one-way (local → GitHub)</li>
  </ul>

  <p>Use <code>dex sync</code> to push tasks, or <code>dex import &lt;issue-url&gt;</code> to pull a GitHub Issue into dex.</p>

  <h3>Auto-Sync</h3>

  <p>By default, tasks sync to GitHub automatically whenever you create, update, or complete a task. You can customize this behavior:</p>

  <Terminal title=".dex/config.toml">
    <Code
      code={`[sync.github]
enabled = true

[sync.github.auto]
# Sync immediately on task mutations (default: true)
on_change = true

# If on_change=false, sync only when last sync exceeds max_age
# Format: "30m", "1h", "1d"
max_age = "1h"`}
      lang="toml"
      theme="vitesse-black"
    />
  </Terminal>

  <table>
    <thead>
      <tr>
        <th>Setting</th>
        <th>Default</th>
        <th>Description</th>
      </tr>
    </thead>
    <tbody>
      <tr>
        <td><code>on_change</code></td>
        <td><code>true</code></td>
        <td>Sync immediately after task create/update/complete</td>
      </tr>
      <tr>
        <td><code>max_age</code></td>
        <td><em>none</em></td>
        <td>If <code>on_change=false</code>, sync on mutation only when last sync exceeds this duration</td>
      </tr>
    </tbody>
  </table>

  <p><strong>Common configurations:</strong></p>
  <ul>
    <li><strong>Always sync</strong> (default): <code>on_change = true</code></li>
    <li><strong>Periodic sync</strong>: <code>on_change = false</code> + <code>max_age = "1h"</code> — syncs only if stale</li>
    <li><strong>Manual only</strong>: <code>on_change = false</code> — only sync via <code>dex sync</code></li>
  </ul>

  <h2>Environment Variables</h2>

  <table>
    <thead>
      <tr>
        <th>Variable</th>
        <th>Description</th>
      </tr>
    </thead>
    <tbody>
      <tr>
        <td><code>DEX_STORAGE_PATH</code></td>
        <td>Override storage directory</td>
      </tr>
      <tr>
        <td><code>GITHUB_TOKEN</code></td>
        <td>GitHub API token (optional if <code>gh</code> CLI is authenticated)</td>
      </tr>
    </tbody>
  </table>
</Base>
